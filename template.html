<div>
<h1>here's the fucking page</h1>

	<div id="document">
		Here should be the flippin' <a href="#"> document </a>
		<canvas id="the_canvas" style="border: 1px solid black;"/>
	</div>

	<div id="questions">
	<div>
</div>

<script src="http://mozilla.github.com/pdf.js/build/pdf.js"></script>  
<script>


function loadUserProgress() {
    pybossa.userProgress('testproj').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}


pybossa.taskLoaded(function(task, deferred) {


	//Not sure we should keep that worker in production
	PDFJS.workerSrc = 'http://mozilla.github.com/pdf.js/build/pdf.worker.js';

	//Here's the code to get the PDF name from the "pdfs" folder and display it into the page
	PDFJS.getDocument("../../../uploads/pdfs/" + task.info.pdf).then(function(pdf) {
		pdf.getPage(task.info.page).then(function(page) {
			var scale = 1.5;
			var viewport = page.getViewport(scale);

			var canvas = document.getElementById('the_canvas');
			var context = canvas.getContext('2d');
			canvas.height = viewport.height;
			canvas.width = viewport.width;

			var renderContext = {
				canvasContext: context,
				viewport: viewport
			};
			page.render(renderContext);
			deferred.resolve(task);
		})
	});
	
	


    /*if ( !$.isEmptyObject(task) ) {
	deferred.resolve(task);
        /*var img = $('<img />');
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
        });
        img.attr('src', task.info.url_b).css('height', 460);
        img.addClass('img-thumbnail img-responsive');
        task.info.image = img;
    }
    else {
        deferred.resolve(task);
    }*/
});

pybossa.presentTask(function(task, deferred) {
    // Code used to create the form
    if ( !$.isEmptyObject(task) ) {
	$('#questions').append("<p><span class='question'></span><form id='choices'></form></p>");
	for(question in task.info.questions){
		$('#choices').append("<fieldset> <legend>" + question + ":</legend>");
		var answer_type = task.info.questions[question][0];
		for(var i = 1; i < task.info.questions[question].length; i++){
			var answer = task.info.questions[question][i]
			// Create the answers according to their type.
			$('#choices').append("<input type='radio' name='" + question + (answer_type  === 'multiple' ? ":" + answer : "")  + "' value='"+answer+ "'>"+answer+"<br>");
		}
		$('#choices').append("</fieldset><br>");
	}
	$('#choices').append("<input id='submit' type='submit' value='Submit'>")

    	//loadUserProgress();
        //$('#document_link').html('').append(task.info.pdf);
        //$("#question").html(task.info.question);
	
	// Submitting the infos of the form and saving it
	$('#choices').submit(function(event) {
		var answer = $('form').serializeArray();
		//permet de voir la r√©ponse... TEST
		console.log(JSON.stringify(answer));
		event.preventDefault();
		//pybossa.saveTask(task.id, answer).done(function(){
		//	deferred.resolve();
		//}
	});
        /*$('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(this).attr("value");
            if (typeof answer != 'undefined') {
                //console.log(answer);
                pybossa.saveTask(task.id, answer).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(500);
                if ($("#disqus_thread").is(":visible")) {
                    $('#disqus_thread').toggle();
                    $('.btn-disqus').toggle();
                }
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();$*/
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

pybossa.run('testproj');
</script>
