<div id='success' style='display:none;'>
	<h2>The task has been successfully saved.</h2>
</div>

<div id='finish' style='display:none;'>
	<h2>You have successfully contributed to all the tasks in this project. Thank you for your time. </h2>
</div>

<div id='missing_check_box' style='display:none;'>
	<h2 id='missing_check_box_phrase' style='color:red;'>All questions are mandatory.</h2>
</div>

<div id='working_page'>
<h1>here's the fucking page</h1>
	
	<div id="document">
		
		<canvas id="the_canvas" style="border: 1px solid black;"/>
	</div>

	<div id="questions">
	<div>
</div>

<script src="http://mozilla.github.com/pdf.js/build/pdf.js"></script>  
<script>

var scale = 1.5;
var canvas = document.getElementById('the_canvas');
var context = canvas.getContext('2d');

//Not sure we should keep that worker in production
PDFJS.workerSrc = 'http://mozilla.github.com/pdf.js/build/pdf.worker.js';

function resetTask(){
	$('#questions').empty();
	context.clearRect ( 0 , 0 , canvas.width, canvas.height );
}


function loadUserProgress() {
    pybossa.userProgress('testproj').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}


pybossa.taskLoaded(function(task, deferred) {
	if ( !$.isEmptyObject(task) ) {
		//Here's the code to get the PDF name from /upload/pdfs/ located at the pybossa root folder 
		//and display it into the page
		PDFJS.getDocument("../../../uploads/pdfs/" + task.info.pdf).then(function(pdf) {
			pdf.getPage(task.info.page).then(function(page) {
				task.p = page;
				deferred.resolve(task);
			})
		});
	} else {
        	deferred.resolve(task);
	}
});

pybossa.presentTask(function(task, deferred) {
	loadUserProgress();
	// Code used to create the form
	if ( !$.isEmptyObject(task) ) {
		var viewport = task.p.getViewport(scale);
		canvas.height = viewport.height;
		canvas.width = viewport.width;

		var renderContext = {
			canvasContext: context,
			viewport: viewport
		};
		
		// Generating the PDF on the canvas
		task.p.render(renderContext);

		var j = 1
		
		// Generating  the HTML
		$('#questions').append("<p><form id='choices'></form></p>");
		for(question in task.info.questions){
			$('#choices').append("<fieldset id='question" + j + "'> <legend>" + question + "</legend> </fieldset>");
			var answer_type = task.info.questions[question][0];
			for(var i = 1; i < task.info.questions[question].length; i++){
				var answer = task.info.questions[question][i]
				// Create the answers according to their type.
				$("#question"+j).append("<input class='possible_answer' type='radio' name='" + question + (answer_type  === 'multiple' ? ":" + answer : "")  + "' value='"+answer+ "'>"+answer+"<br>");
			}
			$('#choices').append("<br>");
			j++;
		}
		$('#choices').append("<input id='submit' type='submit' value='Submit'>")

		// Submitting the infos of the form and saving it in DB
		$('#choices').submit(function(event) {
			event.preventDefault();
			$('html,body').scrollTop(0);

			var unchecked = false;

			var fieldsets = $('fieldset');
			fieldsets.each(function(index, value){
				fieldset = $(this);

				//check is at least 1 box is checked in the fieldset
				var checked = fieldset.find('input:checked').size() > 0;

				if(!checked){
					fieldset.find('legend').css('color','red');
					unchecked = true;
				}
			});

			if(unchecked){
				$('#missing_check_box').show();
			} else {
				$('#missing_check_box').hide();
				var answer = $('form').serializeArray();
				pybossa.saveTask(task.id, answer).done(function(){
					$("#success").fadeIn();
					resetTask();
					setTimeout(function() { $("#success").fadeOut() }, 2000);
					deferred.resolve();
				});
			}
		});
	} else {
		$(".skeleton").hide();
		$("#loading").hide();
		$("#working_page").hide();
		$("#finish").fadeIn(500);
	}
});

pybossa.run('testproj');
</script>
